<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ÐœessageAir.Views.PrivateChatView"
             xmlns:viewModels="clr-namespace:ÐœessageAir.ViewModels"
             xmlns:models="clr-namespace:ÐœessageAir.Models"
             xmlns:converters="clr-namespace:ÐœessageAir.Converters"
             Title="PrivateChat">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚ÐµÑ€Ñ‹ -->
            <converters:DateTimeToDayStringConverter x:Key="FriendlyDateConverter"/>
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter"/>
            <converters:FileSizeConverter x:Key="FileMessageStyle"/>
            <converters:AndMultiValueConverter x:Key="AndConverter" />

            <!-- Ð¡Ñ‚Ð¸Ð»ÑŒ Ð´Ð»Ñ Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð™ Ð¢Ð•ÐšÐ£Ð©Ð•Ð“Ðž Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (ÑÐ¿Ñ€Ð°Ð²Ð°) -->
            <Style x:Key="CurrentUserMessageStyle" TargetType="Frame">
                <Setter Property="CornerRadius" Value="12"/>
                <Setter Property="BackgroundColor" Value="#0084FF"/>
                <Setter Property="Padding" Value="12,8"/>
                <Setter Property="HorizontalOptions" Value="End"/>
                <Setter Property="Margin" Value="40,4,12,4"/>
            </Style>

            <!-- Ð¡Ñ‚Ð¸Ð»ÑŒ Ð´Ð»Ñ Ð¤ÐÐ™Ð›ÐžÐ’ Ð¢Ð•ÐšÐ£Ð©Ð•Ð“Ðž Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (ÑÐ¿Ñ€Ð°Ð²Ð°) -->
            <Style x:Key="MyFileMessageStyle" TargetType="Frame">
                <Setter Property="CornerRadius" Value="12"/>
                <Setter Property="BackgroundColor" Value="#0084FF"/>
                <Setter Property="Padding" Value="12,8"/>
                <Setter Property="HorizontalOptions" Value="End"/>
                <Setter Property="Margin" Value="40,4,12,4"/>
            </Style>

            <!-- Ð¡Ñ‚Ð¸Ð»ÑŒ Ð´Ð»Ñ Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð™ Ð¡ÐžÐ‘Ð•Ð¡Ð•Ð”ÐÐ˜ÐšÐ (ÑÐ»ÐµÐ²Ð°) -->
            <Style x:Key="OtherUserMessageStyle" TargetType="Frame">
                <Setter Property="CornerRadius" Value="12"/>
                <Setter Property="BackgroundColor" Value="#FFFFFF"/>
                <Setter Property="Padding" Value="12,8"/>
                <Setter Property="HorizontalOptions" Value="Start"/>
                <Setter Property="Margin" Value="12,4,40,4"/>
            </Style>

            <!-- Ð¡Ñ‚Ð¸Ð»ÑŒ Ð´Ð»Ñ Ð¤ÐÐ™Ð›ÐžÐ’ Ð¡ÐžÐ‘Ð•Ð¡Ð•Ð”ÐÐ˜ÐšÐ (ÑÐ»ÐµÐ²Ð°) -->
            <Style x:Key="OtherFileMessageStyle" TargetType="Frame">
                <Setter Property="CornerRadius" Value="12"/>
                <Setter Property="BackgroundColor" Value="#FFFFFF"/>
                <Setter Property="Padding" Value="12,8"/>
                <Setter Property="HorizontalOptions" Value="Start"/>
                <Setter Property="Margin" Value="12,4,40,4"/>
            </Style>

            <!-- ÐžÐ±Ñ‰Ð¸Ðµ ÑÑ‚Ð¸Ð»Ð¸ -->
            <Style x:Key="GroupHeaderStyle" TargetType="Label">
                <Setter Property="FontSize" Value="14"/>
                <Setter Property="TextColor" Value="#666666"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="HorizontalOptions" Value="Center"/>
                <Setter Property="Margin" Value="0,15,0,5"/>
                <Setter Property="BackgroundColor" Value="#F5F5F5"/>
                <Setter Property="Padding" Value="10,5"/>
            </Style>

            <Style x:Key="DateContainerStyle" TargetType="Frame">
                <Setter Property="Padding" Value="0"/>
                <Setter Property="BackgroundColor" Value="Transparent"/>
                <Setter Property="HasShadow" Value="False"/>
                <Setter Property="HorizontalOptions" Value="Center"/>
                <Setter Property="Margin" Value="0,15,0,5"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*,Auto,Auto" BackgroundColor="#F9F9F9">
        <!-- ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ -->
        <CollectionView x:Name="MessagesCollectionView"
               ItemsSource="{Binding GroupedMessages}"
               IsGrouped="True"
               SelectionMode="None"
               VerticalScrollBarVisibility="Always"
               EmptyView="No messages yet"
               ItemsUpdatingScrollMode="KeepLastItemInView">

            <!-- Ð¨Ð°Ð±Ð»Ð¾Ð½ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ° Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ -->
            <CollectionView.GroupHeaderTemplate>
                <DataTemplate>
                    <VerticalStackLayout Spacing="0" HorizontalOptions="Center" Margin="0,15,0,5">
                        <Label Text="{Binding Date, Converter={StaticResource FriendlyDateConverter}}" 
                   FontSize="14"
                   TextColor="#666666"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"/>

                        <!-- ÐŸÐ¾Ð»Ð¾ÑÐºÐ° Ð¿Ð¾Ð´ Ð´Ð°Ñ‚Ð¾Ð¹ -->
                        <BoxView HeightRequest="3" 
                     Color="#E0E0E0"
                     HorizontalOptions="Fill"
                     Margin="0,5,0,0"/>
                    </VerticalStackLayout>
                </DataTemplate>
            </CollectionView.GroupHeaderTemplate>

            <!-- Ð¨Ð°Ð±Ð»Ð¾Ð½ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ -->
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:PrivateMessageModel">
                    <Grid>
                        <Frame Style="{StaticResource CurrentUserMessageStyle}">
                            <Frame.IsVisible>
                                <MultiBinding Converter="{StaticResource AndConverter}">
                                    <Binding Path="IsCurrentUser"/>
                                    <Binding Path="HasFile" Converter="{StaticResource InvertedBoolConverter}"/>
                                </MultiBinding>
                            </Frame.IsVisible>
                            <VerticalStackLayout Spacing="4">
                                <Label Text="{Binding Text}" FontSize="16" TextColor="White"/>
                                <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
               FontSize="12" HorizontalOptions="End" TextColor="#A0D6FF"/>
                            </VerticalStackLayout>
                        </Frame>

                        <Frame Style="{StaticResource OtherUserMessageStyle}">
                            <Frame.IsVisible>
                                <MultiBinding Converter="{StaticResource AndConverter}">
                                    <Binding Path="IsCurrentUser" Converter="{StaticResource InvertedBoolConverter}"/>
                                    <Binding Path="HasFile" Converter="{StaticResource InvertedBoolConverter}"/>
                                </MultiBinding>
                            </Frame.IsVisible>
                            <VerticalStackLayout Spacing="4">
                                <Label Text="{Binding FromUserName}" FontAttributes="Bold" FontSize="14" TextColor="#333333"/>
                                <Label Text="{Binding Text}" FontSize="16" TextColor="#333333"/>
                                <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
               FontSize="12" HorizontalOptions="End" TextColor="#666666"/>
                            </VerticalStackLayout>
                        </Frame>

                        <!-- Ð¤Ð°Ð¹Ð»Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (ÑÐ¿Ñ€Ð°Ð²Ð°) -->
                        <Frame Style="{StaticResource MyFileMessageStyle}">
                            <Frame.IsVisible>
                                <MultiBinding Converter="{StaticResource AndConverter}">
                                    <Binding Path="IsCurrentUser"/>
                                    <Binding Path="HasFile"/>
                                </MultiBinding>
                            </Frame.IsVisible>
                            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto" Padding="10">
                                <Label Text="ðŸ“„" Grid.Column="0" Grid.RowSpan="3" FontSize="24"
                           VerticalOptions="Center" Margin="0,0,10,0" TextColor="White"/>
                                <Label Text="{Binding FileName}" Grid.Column="1" Grid.Row="1"
                           FontAttributes="Bold" LineBreakMode="TailTruncation" TextColor="White"/>
                                <HorizontalStackLayout Grid.Column="1" Grid.Row="2" Spacing="10">
                                    <Label Text="{Binding FileData, Converter={StaticResource FileMessageStyle}}"
                               FontSize="12" TextColor="#A0D6FF"/>
                                    <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                               FontSize="12" TextColor="#A0D6FF"/>
                                </HorizontalStackLayout>
                                <Button Text="ðŸ”»" Grid.Column="1" Grid.Row="2" HorizontalOptions="End"
                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:PrivateChatViewModel}}, Path=DownloadFileCommand}"
                            CommandParameter="{Binding .}" BackgroundColor="Transparent"
                            Padding="0" WidthRequest="30"/>
                            </Grid>
                        </Frame>

                        <!-- Ð¤Ð°Ð¹Ð»Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ñ€ÑƒÐ³Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (ÑÐ»ÐµÐ²Ð°) -->
                        <Frame Style="{StaticResource OtherFileMessageStyle}">
                            <Frame.IsVisible>
                                <MultiBinding Converter="{StaticResource AndConverter}">
                                    <Binding Path="IsCurrentUser" Converter="{StaticResource InvertedBoolConverter}"/>
                                    <Binding Path="HasFile"/>
                                </MultiBinding>
                            </Frame.IsVisible>
                            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto" Padding="10">
                                <Label Text="ðŸ“„" Grid.Column="0" Grid.RowSpan="3" FontSize="24"
                           VerticalOptions="Center" Margin="0,0,10,0" TextColor="#333333"/>
                                <Label Text="{Binding FromUserName}" Grid.Column="1" Grid.Row="0"
                           FontAttributes="Bold" TextColor="#333333"/>
                                <Label Text="{Binding FileName}" Grid.Column="1" Grid.Row="1"
                           FontAttributes="Bold" LineBreakMode="TailTruncation" TextColor="#333333"/>
                                <HorizontalStackLayout Grid.Column="1" Grid.Row="2" Spacing="10">
                                    <Label Text="{Binding FileData, Converter={StaticResource FileMessageStyle}}"
                               FontSize="12" TextColor="#666666"/>
                                    <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                               FontSize="12" TextColor="#666666"/>
                                </HorizontalStackLayout>
                                <Button Text="ðŸ”»" Grid.Column="1" Grid.Row="2" HorizontalOptions="End"
                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:PrivateChatViewModel}}, Path=DownloadFileCommand}"
                            CommandParameter="{Binding .}" BackgroundColor="Transparent"
                            Padding="0" WidthRequest="30"/>
                            </Grid>
                        </Frame>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ -->
        <Label Text="{Binding Status}"
               Grid.Row="1"
               HorizontalOptions="Center"
               Margin="0,5"
               FontSize="12"
               TextColor="#666666"/>

        <!-- ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð²Ð²Ð¾Ð´Ð° -->
        <Grid ColumnDefinitions="*,Auto,Auto"
              Padding="10,5"
              Grid.Row="2"
              BackgroundColor="#FFFFFF"
              ColumnSpacing="10">
            <!-- ÐŸÐ¾Ð»Ðµ Ð²Ð²Ð¾Ð´Ð° -->
            <Entry Text="{Binding Message}"
                   TextColor="Black"
                   Grid.Column="0"
                   Placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..."
                   FontSize="16"
                   ClearButtonVisibility="WhileEditing"
                   ReturnCommand="{Binding SendMessageCommand}"
                   VerticalOptions="Center"/>

            <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¿Ñ€Ð¸ÐºÑ€ÐµÐ¿Ð»ÐµÐ½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð° -->
            <Button Grid.Column="1"
                    Text="ðŸ“Ž"
                    Command="{Binding PickAndSendFileCommand}"
                    WidthRequest="50"
                    BackgroundColor="Transparent"
                    TextColor="#0084FF"
                    FontSize="20"
                    CornerRadius="25"/>

            <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ -->
            <Button Grid.Column="2"
                    Text="ÐžÑ‚Ð¿Ñ€."
                    Command="{Binding SendMessageCommand}"
                    WidthRequest="80"
                    BackgroundColor="#0084FF"
                    TextColor="White"
                    CornerRadius="5"
                    FontSize="14"/>
        </Grid>
    </Grid>

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Back" Command="{Binding BackCommand}"/>
        <ToolbarItem Text="GoToProfile" Command="{Binding GoToProfileCommand}"/>
    </ContentPage.ToolbarItems>
</ContentPage>